<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Cat Garden</title>
  <style>
    :root{
      --panel: rgba(255,255,255,.9);
      --shadow: 0 10px 22px rgba(0,0,0,.12);
    }
    body{
      margin:0;
      overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:#6ed38b;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;
    }

    /* UI */
    #ui{
      position:fixed;
      top:12px; left:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      z-index:20;
      align-items:center;
    }
    .btn,.pill{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      background:var(--panel);
      box-shadow:var(--shadow);
      font-weight:800;
      display:flex;
      gap:8px;
      align-items:center;
      font-size:14px;
    }
    .btn{ cursor:pointer; }
    .btn:active{ transform: translateY(1px); }
    .pill{ font-size:13px; }

    /* Viewport + world (giardino grande) */
    #viewport{
      position:relative;
      width:100vw;
      height:100vh;
      overflow:hidden;
      touch-action:none;
    }
    /* prato pixel stile ‚Äúfoto esempio‚Äù */
    #world{
      position:absolute;
      left:0; top:0;
      width:3000px;
      height:3000px;
      background:
        radial-gradient(rgba(255,255,255,.10) 1px, transparent 2px) 0 0/20px 20px,
        radial-gradient(rgba(0,0,0,.07) 1px, transparent 2px) 8px 10px/22px 22px,
        linear-gradient(#7adf92,#5fd786);
    }
    /* qualche dettaglio (chiazze/fiorellini) */
    #world::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 12% 24%, rgba(255,255,255,.14) 0 10px, transparent 11px),
        radial-gradient(circle at 22% 78%, rgba(255,255,255,.12) 0 8px, transparent 9px),
        radial-gradient(circle at 68% 52%, rgba(255,255,255,.12) 0 12px, transparent 13px),
        radial-gradient(circle at 84% 18%, rgba(255,255,255,.10) 0 9px, transparent 10px),
        radial-gradient(circle at 45% 40%, rgba(0,0,0,.05) 0 18px, transparent 19px),
        radial-gradient(circle at 75% 70%, rgba(0,0,0,.04) 0 16px, transparent 17px);
      opacity:.7;
      pointer-events:none;
    }

    /* Cat */
    .cat{
      position:absolute;
      width:64px;
      height:64px;
      cursor:pointer;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.22));
      transition: transform 6.5s linear;
    }
    .owned{
      outline:3px solid rgba(255,215,0,.85);
      outline-offset:6px;
      border-radius:14px;
    }

    .sprite{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:48px;
      height:48px;
      background-repeat:no-repeat;
      background-size: calc(48px * 4) 48px;
      image-rendering: pixelated;
      animation: walk 900ms steps(4) infinite;
    }
    @keyframes walk{
      from{ background-position: 0 0; }
      to{ background-position: -192px 0; }
    }

    .label{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:-18px;
      font-size:11px;
      font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      white-space:nowrap;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .petcount{ opacity:.85; font-weight:1000; }

    .heart{
      position:absolute;
      font-size:18px;
      animation: pop 850ms ease-out forwards;
      pointer-events:none;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
    }
    @keyframes pop{
      0%{ transform: translateY(0) scale(.8); opacity:0; }
      15%{ opacity:1; }
      100%{ transform: translateY(-42px) scale(1.25); opacity:0; }
    }

    /* Modale nome */
    #modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:18px;
    }
    #modal{
      width:min(520px, 100%);
      background: rgba(255,255,255,.96);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      padding:16px;
    }
    #modal h3{ margin:0 0 10px 0; font-size:16px; }
    #nameInput{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.15);
      font-size:16px;
      outline:none;
    }
    #modalActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:12px;
    }
  </style>
</head>
<body>

  <div id="ui">
    <button class="btn" id="adopt">‚ûï Adotta un gatto</button>
    <button class="btn" id="center" disabled>üéØ Trova il mio gatto</button>
    <div class="pill">üê± <span id="totCats">0</span> ‚Ä¢ üíó <span id="totPets">0</span></div>
  </div>

  <div id="viewport">
    <div id="world"></div>
  </div>

  <!-- Modale nome -->
  <div id="modalBackdrop">
    <div id="modal">
      <h3>Come vuoi chiamare il tuo gatto?</h3>
      <input id="nameInput" placeholder="Es. Muffin, Luna, Pixel..." maxlength="20" />
      <div id="modalActions">
        <button class="btn" id="cancelName">Annulla</button>
        <button class="btn" id="confirmName">Conferma</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const WORLD_W = 3000;
const WORLD_H = 3000;

const AMBIENT_CATS = 10;          // pi√π ‚Äúvivo‚Äù
const MOVE_EVERY_MS_MIN = 6500;   // pi√π lento
const MOVE_EVERY_MS_MAX = 9500;
const MOVE_RADIUS = 220;          // quanto ‚Äúvaga‚Äù ogni volta

/* =========================
   DOM
========================= */
const viewport = document.getElementById("viewport");
const world = document.getElementById("world");
const totCatsEl = document.getElementById("totCats");
const totPetsEl = document.getElementById("totPets");
const btnAdopt = document.getElementById("adopt");
const btnCenter = document.getElementById("center");

const modalBackdrop = document.getElementById("modalBackdrop");
const nameInput = document.getElementById("nameInput");
const cancelName = document.getElementById("cancelName");
const confirmName = document.getElementById("confirmName");

/* =========================
   STATE
========================= */
let totalPets = 0;
let ownedCats = [];
let lastOwned = null;

// camera (trascinabile)
let camX = (WORLD_W/2) - (window.innerWidth/2);
let camY = (WORLD_H/2) - (window.innerHeight/2);
let dragging = false;
let startPX = 0, startPY = 0;
let startCamX = 0, startCamY = 0;

// adozione con nome
let pendingAdopt = false;

/* =========================
   UTIL
========================= */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function rand(min,max){ return Math.random()*(max-min)+min; }
function randi(min,max){ return Math.floor(rand(min,max)); }

function updateCounters(){
  totCatsEl.textContent = String(document.querySelectorAll(".cat").length);
  totPetsEl.textContent = String(totalPets);
  btnCenter.disabled = ownedCats.length === 0;
}

function setCamera(x,y){
  camX = clamp(x, 0, WORLD_W - window.innerWidth);
  camY = clamp(y, 0, WORLD_H - window.innerHeight);
  world.style.transform = `translate(${-camX}px, ${-camY}px)`;
}

function centerCameraOnWorldPoint(wx, wy){
  setCamera(wx - window.innerWidth/2, wy - window.innerHeight/2);
}

function worldPointFromViewport(clientX, clientY){
  // coordinate nel mondo
  const wx = clientX + camX;
  const wy = clientY + camY;
  return {wx, wy};
}

function heartAtWorld(wx, wy){
  const h = document.createElement("div");
  h.className = "heart";
  h.textContent = "üíó";
  // posiziona nel mondo (quindi dentro #world)
  h.style.left = (wx + rand(-6,6)) + "px";
  h.style.top  = (wy + rand(-10,2)) + "px";
  world.appendChild(h);
  setTimeout(()=>h.remove(), 900);
}

/* =========================
   SPRITE (GATTO SAGOMATO, NON QUADRATO)
   - canvas con trasparenza
   - 4 frame, zampette alternate
========================= */
function makeCatSpriteSheet(coat){
  const frameW=48, frameH=48, frames=4;
  const c=document.createElement("canvas");
  c.width=frameW*frames; c.height=frameH;
  const ctx=c.getContext("2d");

  function px(x,y,w,h,col){
    ctx.fillStyle=col;
    ctx.fillRect(x,y,w,h);
  }

  const outline="rgba(0,0,0,.28)";
  const eye="#1a1a1a";
  const nose="#ff5da2";
  const highlight="rgba(255,255,255,.22)";

  for(let f=0; f<frames; f++){
    const ox=f*frameW;
    ctx.clearRect(ox,0,frameW,frameH);

    const step = (f%2===0) ? 0 : 2;

    // --- corpo sagomato (con ‚Äúvuoti‚Äù attorno = trasparenza)
    // orecchie (triangolini pixel)
    px(ox+14, 11, 6, 6, coat);
    px(ox+28, 11, 6, 6, coat);

    // testa (arrotondata a pixel)
    px(ox+14, 16, 20, 14, coat);
    px(ox+16, 14, 16, 2, coat);

    // corpo
    px(ox+16, 30, 18, 10, coat);
    px(ox+18, 28, 14, 2, coat);

    // coda (staccata, d√† silhouette ‚Äúgatto‚Äù)
    px(ox+34, 32, 6, 2, coat);
    px(ox+38, 30, 2, 8, coat);

    // zampe (alternate)
    px(ox+18, 40, 4, 4, coat);
    px(ox+24, 40-step, 4, 4, coat);
    px(ox+30, 40, 4, 4, coat);

    // outline leggero (solo su alcuni blocchi per non ‚Äúsquadrarlo‚Äù)
    ctx.strokeStyle = outline;
    ctx.lineWidth = 2;
    ctx.strokeRect(ox+14,16,20,14);
    ctx.strokeRect(ox+16,30,18,10);

    // faccia
    px(ox+20, 22, 2, 2, eye);
    px(ox+28, 22, 2, 2, eye);
    px(ox+24, 25, 2, 2, nose);

    // highlight
    px(ox+18, 18, 2, 2, highlight);
  }

  return c.toDataURL("image/png");
}

/* =========================
   COLORI PELO CASUALI (senza rarit√†)
========================= */
const COATS = [
  "#2b2b2b", "#f2f2f2", "#caa472", "#9c7a5b", "#bdbdbd",
  "#ffb703", "#ff006e", "#8338ec", "#3a86ff", "#06d6a0",
  "#ff7b00", "#00e5ff"
];

function randomCoat(){
  return COATS[randi(0, COATS.length)];
}

/* =========================
   CREATE CAT
========================= */
function createCat({owned=false, name="Gatto"}){
  const coat = randomCoat();

  const cat = document.createElement("div");
  cat.className = "cat";
  cat.style.left = randi(80, WORLD_W-120) + "px";
  cat.style.top  = randi(80, WORLD_H-120) + "px";

  if(owned){
    cat.classList.add("owned");
    ownedCats.push(cat);
    lastOwned = cat;
  }

  const label = document.createElement("div");
  label.className = "label";
  label.innerHTML = `<span>${name}</span> ‚Ä¢ <span class="petcount">0</span>`;
  cat.appendChild(label);

  const sprite = document.createElement("div");
  sprite.className = "sprite";
  sprite.style.backgroundImage = `url(${makeCatSpriteSheet(coat)})`;
  cat.appendChild(sprite);

  cat.dataset.pets = "0";
  cat.dataset.name = name;

  cat.addEventListener("click", (ev)=>{
    const {wx, wy} = worldPointFromViewport(ev.clientX, ev.clientY);

    const n = (parseInt(cat.dataset.pets,10) || 0) + 1;
    cat.dataset.pets = String(n);
    label.querySelector(".petcount").textContent = String(n);

    totalPets++;
    updateCounters();
    heartAtWorld(wx, wy);
  });

  world.appendChild(cat);
  startWander(cat);
  updateCounters();
  return cat;
}

/* =========================
   MOVIMENTO LENTO (facile da seguire)
========================= */
function startWander(cat){
  let baseX = parseFloat(cat.style.left);
  let baseY = parseFloat(cat.style.top);

  function step(){
    // target vicino (vagare)
    const tx = clamp(baseX + rand(-MOVE_RADIUS, MOVE_RADIUS), 30, WORLD_W-90);
    const ty = clamp(baseY + rand(-MOVE_RADIUS, MOVE_RADIUS), 30, WORLD_H-90);

    // flip direzione
    const dx = tx - baseX;
    const flip = dx < 0 ? -1 : 1;

    // aggiorna base
    baseX = tx; baseY = ty;

    // applica: pos assoluta + translate + flip
    cat.style.left = tx + "px";
    cat.style.top  = ty + "px";
    cat.style.transform = `translate(0,0) scaleX(${flip})`;

    // prossima mossa (lenta)
    const nextIn = randi(MOVE_EVERY_MS_MIN, MOVE_EVERY_MS_MAX);
    setTimeout(step, nextIn);
  }

  // parte dopo un po‚Äô
  setTimeout(step, randi(900, 1800));
}

/* =========================
   CAMERA DRAG (trascina per esplorare)
========================= */
viewport.addEventListener("pointerdown", (e)=>{
  dragging = true;
  viewport.setPointerCapture(e.pointerId);
  startPX = e.clientX;
  startPY = e.clientY;
  startCamX = camX;
  startCamY = camY;
});

viewport.addEventListener("pointermove", (e)=>{
  if(!dragging) return;
  const dx = e.clientX - startPX;
  const dy = e.clientY - startPY;
  // trascini il dito -> muovi camera opposta
  setCamera(startCamX - dx, startCamY - dy);
});

viewport.addEventListener("pointerup", ()=>{
  dragging = false;
});

/* =========================
   ADOZIONE CON NOME (MODALE)
========================= */
function openNameModal(){
  pendingAdopt = true;
  nameInput.value = "";
  modalBackdrop.style.display = "flex";
  setTimeout(()=> nameInput.focus(), 50);
}
function closeNameModal(){
  pendingAdopt = false;
  modalBackdrop.style.display = "none";
}

// ‚úÖ LINK STRIPE (TEST)
const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/test_3cIbJ22rqeYE5eH6ui0x200";

// contatore ‚Äúgatti pagati‚Äù da riscattare (salvato nel browser)
let pendingPaidCats = parseInt(sessionStorage.getItem("pendingPaidCats") || "0", 10);

// Se l‚Äôutente torna da Stripe con ?paid=1, aggiungiamo 1 ‚Äúriscatto‚Äù
(function handleReturnFromStripe(){
  const url = new URL(window.location.href);
  const paid = url.searchParams.get("paid");

  if(paid === "1"){
    pendingPaidCats += 1;
    sessionStorage.setItem("pendingPaidCats", String(pendingPaidCats));

    // pulisci la URL (cos√¨ non crea gatti a ogni refresh)
    url.searchParams.delete("paid");
    window.history.replaceState({}, "", url.toString());

    // apri subito la scelta nome
    openNameModal();
  }
})();

// Quando clicchi il bottone:
btnAdopt.addEventListener("click", ()=>{
  // se hai gi√† un riscatto disponibile, fai scegliere nome e crea gatto
  pendingPaidCats = parseInt(sessionStorage.getItem("pendingPaidCats") || "0", 10);

  if(pendingPaidCats > 0){
    openNameModal();
  } else {
    // altrimenti vai a pagare su Stripe
    window.location.href = STRIPE_PAYMENT_LINK;
  }
});

cancelName.addEventListener("click", closeNameModal);
modalBackdrop.addEventListener("click", (e)=>{
  if(e.target === modalBackdrop) closeNameModal();
});

confirmName.addEventListener("click", ()=>{
  if(!pendingAdopt) return;
  let nm = (nameInput.value || "").trim();
  if(!nm) nm = "Il mio gatto";

  const c = createCat({owned:true, name:nm});

  // centra subito sul tuo gatto (cos√¨ lo trovi sempre)
  const cx = parseFloat(c.style.left);
  const cy = parseFloat(c.style.top);
  centerCameraOnWorldPoint(cx, cy);

  closeNameModal();
});

btnCenter.addEventListener("click", ()=>{
  if(!lastOwned) return;
  const cx = parseFloat(lastOwned.style.left);
  const cy = parseFloat(lastOwned.style.top);
  centerCameraOnWorldPoint(cx, cy);
});

/* =========================
   INIT
========================= */
world.style.width = WORLD_W + "px";
world.style.height = WORLD_H + "px";
setCamera(camX, camY);

// gatti ambientali
for(let i=0;i<AMBIENT_CATS;i++){
  createCat({owned:false, name:"Gatto"});
}
updateCounters();

// se ruoti lo schermo
window.addEventListener("resize", ()=>{
  setCamera(camX, camY);
});
</script>
</body>
</html>
