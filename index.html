<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cat Garden</title>
  <style>
    :root{
      --panel: rgba(255,255,255,.9);
      --shadow: 0 10px 22px rgba(0,0,0,.12);
    }
    body{
      margin:0; overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:#77d88a;
      user-select:none;
    }
    #garden{
      position:relative;
      width:100vw; height:100vh;
      background:
        radial-gradient(rgba(255,255,255,.10) 1px, transparent 2px) 0 0/22px 22px,
        radial-gradient(rgba(0,0,0,.06) 1px, transparent 2px) 10px 8px/18px 18px,
        linear-gradient(#7be08f,#61d38a);
    }
    /* qualche fiorellino */
    #garden::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 14% 72%, rgba(255,255,255,.25) 0 7px, transparent 8px),
        radial-gradient(circle at 28% 55%, rgba(255,255,255,.20) 0 6px, transparent 7px),
        radial-gradient(circle at 62% 68%, rgba(255,255,255,.22) 0 7px, transparent 8px),
        radial-gradient(circle at 82% 44%, rgba(255,255,255,.18) 0 6px, transparent 7px);
      opacity:.55; pointer-events:none;
    }

    #ui{
      position:fixed; top:12px; left:12px;
      display:flex; gap:10px; flex-wrap:wrap;
      z-index:10;
    }
    .btn, .pill{
      border:none; border-radius:14px;
      padding:10px 12px;
      background:var(--panel);
      box-shadow:var(--shadow);
      font-weight:800;
      display:flex; gap:8px; align-items:center;
    }
    .btn{ cursor:pointer; }
    .btn:active{ transform: translateY(1px); }
    .pill{ font-size:13px; }

    /* Cat container */
    .cat{
      position:absolute;
      width:64px; height:64px;
      transition: transform 3.2s linear;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.22));
      cursor:pointer;
    }
    .owned{
      outline:3px solid rgba(255,215,0,.85);
      outline-offset:6px;
      border-radius:14px;
      animation: glow 1.4s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{ filter: drop-shadow(0 0 8px rgba(255,215,0,.25)) drop-shadow(0 10px 10px rgba(0,0,0,.22)); }
      to  { filter: drop-shadow(0 0 14px rgba(255,215,0,.55)) drop-shadow(0 10px 10px rgba(0,0,0,.22)); }
    }

    /* sprite: 4 frame in orizzontale */
    .sprite{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:48px; height:48px;
      background-repeat:no-repeat;
      background-size: calc(48px * 4) 48px;
      image-rendering: pixelated;
      animation: walk 520ms steps(4) infinite;
    }
    @keyframes walk{
      from { background-position: 0 0; }
      to   { background-position: -192px 0; } /* 48*4 */
    }

    .label{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:-18px;
      font-size:11px;
      font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      white-space:nowrap;
      display:flex; gap:6px; align-items:center;
    }
    .petcount{ opacity:.85; font-weight:1000; }

    .hat{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:-6px;
      font-size:16px;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
      pointer-events:none;
    }

    .heart{
      position:absolute;
      font-size:18px;
      animation: pop 850ms ease-out forwards;
      pointer-events:none;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
    }
    @keyframes pop{
      0%{ transform: translateY(0) scale(.8); opacity:0; }
      15%{ opacity:1; }
      100%{ transform: translateY(-42px) scale(1.25); opacity:0; }
    }
  </style>
</head>
<body>
  <div id="ui">
    <button class="btn" id="adopt">‚ûï Adotta un gatto</button>
    <button class="btn" id="center" disabled>üéØ Trova il mio gatto</button>
    <button class="btn" id="sound">üîá Fusa: OFF</button>
    <div class="pill">üê± <span id="totCats">0</span> ‚Ä¢ üíó <span id="totPets">0</span></div>
  </div>

  <div id="garden"></div>

<script>
const garden = document.getElementById("garden");
const totCatsEl = document.getElementById("totCats");
const totPetsEl = document.getElementById("totPets");
const btnAdopt = document.getElementById("adopt");
const btnCenter = document.getElementById("center");
const btnSound = document.getElementById("sound");

let totalPets = 0;
let soundEnabled = false;

let ownedCats = [];
let lastOwned = null;

/* ----------------- RARIT√Ä + COLORI ----------------- */
const rarities = [
  { key:"COMUNE", chance:70, colors:["#2b2b2b","#f2f2f2","#caa472","#9c7a5b","#bdbdbd"] },
  { key:"RARA", chance:20, colors:["#4da3ff","#ff4d6d","#00c2a8","#ffd166","#a0c4ff"] },
  { key:"EPICA", chance:8,  colors:["#7b2cbf","#00bbf9","#ff6d00","#ff00ff","#00ffd5"] },
  { key:"LEGGENDARIA", chance:2, colors:["#ffd700","#ff1744","#00ff7f","#00e5ff","#ff7b00"] },
];

const hats = [
  { hat:null, chance:55 },
  { hat:"üé©", chance:10 },
  { hat:"üß¢", chance:10 },
  { hat:"üéÄ", chance:8 },
  { hat:"üå∏", chance:8 },
  { hat:"üéì", chance:4 },
  { hat:"üëë", chance:3 },
  { hat:"‚ú®", chance:2 }
];

function rand(min,max){ return Math.random()*(max-min)+min; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

function weightedPick(list){
  const roll = Math.random()*100;
  let sum=0;
  for(const it of list){
    sum += it.chance;
    if(roll <= sum) return it;
  }
  return list[list.length-1];
}

function makeName(){
  const a=["Micio","Luna","Puff","Nerino","Zaffiro","Pixel","Menta","Biscotto","Ombra","Sushi","Nube"];
  const b=["del Giardino","Stellare","Arcobaleno","Silenzioso","Fortunato","Sognatore","d'Inverno","di Primavera","del Mana"];
  return a[Math.floor(Math.random()*a.length)]+" "+b[Math.floor(Math.random()*b.length)];
}

/* ----------------- PURR (audio) ----------------- */
let audioCtx=null;
function startAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==="suspended") audioCtx.resume();
}
function playPurr(){
  if(!soundEnabled) return;
  startAudio();
  const ctx=audioCtx, duration=.55;

  const osc=ctx.createOscillator();
  osc.type="sine";
  osc.frequency.value=34+Math.random()*8;

  const gain=ctx.createGain();
  gain.gain.value=0;

  const bufferSize = ctx.sampleRate*duration;
  const buffer=ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const data=buffer.getChannelData(0);
  for(let i=0;i<bufferSize;i++) data[i]=(Math.random()*2-1)*0.18;
  const noise=ctx.createBufferSource(); noise.buffer=buffer;

  const filter=ctx.createBiquadFilter();
  filter.type="lowpass"; filter.frequency.value=160;

  osc.connect(gain);
  noise.connect(filter); filter.connect(gain);
  gain.connect(ctx.destination);

  const now=ctx.currentTime;
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(.18, now+.05);
  gain.gain.linearRampToValueAtTime(0, now+duration);

  osc.start(now); noise.start(now);
  osc.stop(now+duration); noise.stop(now+duration);
}

/* ----------------- SPRITE GENERATOR -----------------
   Genera una sprite-sheet 4 frame (48x48 ogni frame) stile pixel.
   (Canvas -> dataURL). Cos√¨ non scarichi immagini.
------------------------------------------------------ */
function makeCatSpriteSheet(colorHex){
  const frameW=48, frameH=48, frames=4;
  const c=document.createElement("canvas");
  c.width=frameW*frames; c.height=frameH;
  const ctx=c.getContext("2d");

  function px(x,y,w,h,col){
    ctx.fillStyle=col;
    ctx.fillRect(x,y,w,h);
  }

  const outline="rgba(0,0,0,.28)";
  const eye="#121212";
  const nose="#f0a";

  for(let f=0; f<frames; f++){
    const ox=f*frameW;
    // clear frame
    ctx.clearRect(ox,0,frameW,frameH);

    // "bounce" e "passi": muove zampette
    const step = f%2===0 ? 0 : 2;

    // corpo (pixel block)
    // testa
    px(ox+14, 14, 20, 18, colorHex);
    // orecchie
    px(ox+14, 10, 6, 6, colorHex);
    px(ox+28, 10, 6, 6, colorHex);
    // corpo
    px(ox+16, 30, 18, 10, colorHex);
    // coda
    px(ox+34, 32, 6, 6, colorHex);

    // zampe (alternate)
    px(ox+16, 40, 4, 4, colorHex);
    px(ox+22, 40-step, 4, 4, colorHex);
    px(ox+28, 40, 4, 4, colorHex);
    px(ox+34, 40-step, 4, 4, colorHex);

    // outline (semplice)
    ctx.strokeStyle = outline;
    ctx.lineWidth = 2;
    ctx.strokeRect(ox+14,14,20,18);
    ctx.strokeRect(ox+16,30,18,10);

    // occhi
    px(ox+20, 22, 2, 2, eye);
    px(ox+28, 22, 2, 2, eye);
    // naso
    px(ox+24, 26, 2, 2, nose);

    // piccoli highlights
    px(ox+17, 17, 2, 2, "rgba(255,255,255,.25)");
  }

  return c.toDataURL("image/png");
}

/* ----------------- UI HELPERS ----------------- */
function updateCounters(){
  totCatsEl.textContent = String(document.querySelectorAll(".cat").length);
  totPetsEl.textContent = String(totalPets);
  btnCenter.disabled = ownedCats.length===0;
}

function heartAt(x,y){
  const h=document.createElement("div");
  h.className="heart";
  h.textContent="üíó";
  h.style.left=(x+rand(-6,6))+"px";
  h.style.top=(y+rand(-10,2))+"px";
  garden.appendChild(h);
  setTimeout(()=>h.remove(), 900);
}

/* Muove il gatto e lo "gira" se va a sinistra/destra */
function wander(cat){
  let prevX = 0;

  const step=()=>{
    const maxX=window.innerWidth-90, maxY=window.innerHeight-90;
    const nx=clamp(rand(20,maxX),0,maxX);
    const ny=clamp(rand(80,maxY),0,maxY);

    // direzione
    const dx = nx - prevX;
    prevX = nx;
    const flip = dx < 0 ? -1 : 1;

    // trasformazione: translate + flip (mantiene camminata sprite)
    cat.style.transform = `translate(${nx}px, ${ny}px) scaleX(${flip})`;
  };

  setTimeout(step, rand(200,900));
  setInterval(step, 3200 + Math.random()*1200);
}

function centerOn(cat){
  if(!cat) return;
  const cx=window.innerWidth/2-32;
  const cy=window.innerHeight/2-32;
  cat.style.left=cx+"px";
  cat.style.top=cy+"px";
  cat.style.transform="translate(0,0) scaleX(1)";
}

/* ----------------- CREATE CAT ----------------- */
function createCat({owned=false}){
  const rarity = weightedPick(rarities);
  const color = rarity.colors[Math.floor(Math.random()*rarity.colors.length)];
  const hat = weightedPick(hats).hat;
  const name = makeName();

  const cat=document.createElement("div");
  cat.className="cat";
  cat.style.left = rand(20, window.innerWidth-120) + "px";
  cat.style.top  = rand(80, window.innerHeight-140) + "px";

  if(owned){
    cat.classList.add("owned");
    ownedCats.push(cat);
    lastOwned = cat;
  }

  const label=document.createElement("div");
  label.className="label";
  label.innerHTML = `<span>${rarity.key}</span> ‚Ä¢ <span>${name}</span> ‚Ä¢ <span class="petcount">0</span>`;
  cat.appendChild(label);

  if(hat){
    const h=document.createElement("div");
    h.className="hat";
    h.textContent=hat;
    cat.appendChild(h);
  }

  const sprite=document.createElement("div");
  sprite.className="sprite";
  sprite.style.backgroundImage = `url(${makeCatSpriteSheet(color)})`;
  cat.appendChild(sprite);

  cat.dataset.pets="0";

  cat.addEventListener("click",(ev)=>{
    const rect=garden.getBoundingClientRect();
    const cx=ev.clientX-rect.left;
    const cy=ev.clientY-rect.top;

    const n=(parseInt(cat.dataset.pets,10)||0)+1;
    cat.dataset.pets=String(n);
    label.querySelector(".petcount").textContent = String(n);

    totalPets++;
    updateCounters();

    heartAt(cx,cy);
    playPurr();
  });

  garden.appendChild(cat);
  wander(cat);
  updateCounters();
  return cat;
}

/* ----------------- UI EVENTS ----------------- */
btnAdopt.addEventListener("click", ()=>{
  startAudio();
  const c = createCat({owned:true});
  centerOn(c); // subito visibile
});

btnCenter.addEventListener("click", ()=> centerOn(lastOwned));

btnSound.addEventListener("click", ()=>{
  startAudio();
  soundEnabled = !soundEnabled;
  btnSound.textContent = soundEnabled ? "üîä Fusa: ON" : "üîá Fusa: OFF";
});

/* ambient cats */
for(let i=0;i<7;i++) createCat({owned:false});
</script>
</body>
</html>
